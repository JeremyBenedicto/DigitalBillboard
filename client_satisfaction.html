<!DOCTYPE html>
<html lang="tl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Client Satisfaction Measurement (CSM) Form</title>

  <!-- PDF libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body {
      font-family: "Arial", sans-serif;
      background: #f9f9f9;
      color: #000;
      margin: 0;
      padding: 0;
      font-size: 16px;
    }

    .container {
      max-width: 950px;
      background: #fff;
      margin: 30px auto;
      padding: 40px 60px;
      border: 1px solid #ccc;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    header {
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      margin-bottom: 30px;
      line-height: 1.4;
      position: relative;
    }

    header img {
      position: absolute;
      left: 20px;
      top: 5px;
      width: 70px;
      height: 70px;
      object-fit: contain;
    }

    header h2 {
      font-size: 20px;
      margin: 0;
      font-weight: bold;
    }

    header h3 {
      font-size: 18px;
      margin: 0;
    }

    .divider {
      border-bottom: 1px solid #000;
      margin: 15px 0;
    }

    h4.section-title {
      text-align: center;
      font-weight: bold;
      text-transform: uppercase;
      margin-top: 30px;
      margin-bottom: 15px;
    }

    p.instructions {
      text-align: justify;
      font-size: 16px;
    }

    .form-section {
      margin-top: 20px;
    }

    label {
      font-weight: 600;
    }

    .form-group {
      margin-bottom: 12px;
    }

    .inline-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    input[type="text"],
    input[type="date"],
    input[type="number"],
    textarea,
    select {
      border: 1px solid #ccc;
      padding: 8px 12px;
      width: 100%;
      border-radius: 4px;
      box-sizing: border-box;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    #office-selector-container {
      max-width: 500px;
      margin: 10px auto;
    }

    #office-selector-container label {
      display: block;
      margin-bottom: 5px;
      font-weight: normal;
      text-align: left;
    }

    #otherOfficeName {
      margin-top: 5px;
    }

    textarea {
      min-height: 80px;
      resize: vertical;
    }

    .checkbox-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: normal;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 15px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
      font-size: 15px;
      vertical-align: middle;
    }

    th {
      background-color: #efefef;
    }

    .question {
      text-align: left;
      font-weight: normal;
    }

    .emoji {
      font-size: 28px;
      display: block;
    }

    .red { color: #e74c3c; }
    .orange { color: #e67e22; }
    .gray { color: #7f8c8d; }
    .lightgreen { color: #2ecc71; }
    .green { color: #27ae60; }
    .na { color: #95a5a6; }

    .grayscale {
      filter: grayscale(100%);
    }

    .submit-btn {
      display: block;
      margin: 30px auto 10px;
      padding: 10px 30px;
      background-color: #007BFF;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
    }

    .submit-btn:hover {
      background-color: #0056b3;
    }

    .submit-btn:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }

    .footer {
      text-align: center;
      margin-top: 20px;
      font-weight: bold;
    }

    .page-break {
      page-break-before: always;
      margin-top: 50px;
    }

    #overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      color: white;
      font-size: 22px;
      text-align: center;
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }

    #overlay p {
      background: rgba(0,0,0,0.8);
      padding: 20px 40px;
      border-radius: 10px;
    }

    /* Virtual Keyboard styles */
    #virtual-keyboard {
      display: none;
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      max-width: 900px;
      width: 100%;
      padding: 8px;
      background: #f0f0f0;
      box-shadow: 0 -3px 10px rgba(0,0,0,0.2);
      z-index: 10000;
      box-sizing: border-box;
    }

    .keyboard-row {
      display: flex;
      justify-content: center;
      gap: 6px;
      margin-bottom: 6px;
    }

    .keyboard-key {
      font-family: Arial, sans-serif;
      font-size: 24px;
      padding: 0;
      height: 60px;
      min-width: 40px;
      flex-grow: 1;
      flex-basis: 0;
      background: #ffffff;
      border: 1px solid #aaa;
      border-radius: 6px;
      cursor: pointer;
      box-shadow: 0 2px 2px rgba(0,0,0,0.15);
      transition: all 0.05s ease;
      font-weight: bold;
    }

    .key-special {
      flex-grow: 1.5;
      flex-basis: 0;
      background: #cdd8e6;
      font-size: 20px;
    }

    .key-backspace {
      flex-grow: 2;
    }

    .key-space {
      flex-grow: 12;
    }

    .key-shift-active {
      background: #007BFF;
      color: white;
    }

    .key-close {
      background: #e6cdd0;
    }

    /* Back button */
    .back-button {
      position: fixed;
      top: 15px;
      left: 15px;
      z-index: 1000;
      padding: 10px 15px;
      background-color: #dcdada;
      color: #333;
      border: 1px solid #ccc;
      border-radius: 20px;
      text-decoration: none;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      transition: background-color 0.2s, transform 0.1s;
      font-size: 14px;
    }

    .back-button:hover { background-color: #e0e0e0; transform: translateY(-1px); }
    .back-button:active { transform: translateY(0); }

    @media print {
      #office-selector-container {
        display: none !important;
      }
    }
  </style>
</head>
<body>
  <!-- BACK BUTTON -->
  <a href="javascript:void(0);" class="back-button" onclick="window.history.back();">&larr;</a>

  <!-- Overlay -->
  <div id="overlay"><p>Loading...</p></div>

  <!-- PAGE 1 -->
  <div class="container" id="page1">
    <header>
      <div style="width:100%">
        <h3>Republic of the Philippines</h3>
        <h3>PROVINCE OF NUEVA ECIJA</h3>
        <h3>Municipality of Gabaldon</h3>
        <p><b>- oOo -</b></p>
        <h2 id="officeTitle">PAMBAYANG TANGGAPAN NG TAGATALA</h2>

        <!-- Office Selector -->
        <div id="office-selector-container" style="margin-top: 20px;">
          <label for="officeSelect">Piliin ang TANGGAPAN na sinerbisyuhan:</label>
          <select id="officeSelect" onchange="updateOfficeTitle(this.value)">
            <option value="TAGATALA" selected>REGISTRY</option>
            <option value="AGRIKULTURA">AGRICULTURE</option>
            <option value="INHINYERO">ENGINEERING</option>
            <option value="INGAT-YAMAN">TREASURY</option>
            <option value="KALUSUGANG BAYAN">RHU</option>
            <option value="PAGPAPLANO AT PAGPAPAUNLAD">PLANNING AND DEVELOPMENT</option>
            <option value="PUNONG BAYAN">MAYOR'S OFFICE</option>
            <option value="PAMAMAHALA SA YAMANG TAO">HRMO (HUMAN RESOURCE MANAGEMENT)</option>
            <option value="BADYET">BUDGET OFFICE</option>
            <option value="TAGASURI">ASSESSOR'S OFFICE</option>
            <option value="KALIKASAN AT LIKAS NA YAMAN">MENRO (ENVIRONMENT AND NATURAL RESOURCES)</option>
            <option value="PANANALAPI">ACCOUNTING</option>
            <option value="SISTEMA NG TUBIG">WATER SYSTEM</option>
            <option value="SANGGUNIANG BAYAN">SANGGUNIANG BAYAN</option>
            <option value="PAMBAYANG PAMAMAHALA SA SAKUNA AT KALAMIDAD">MDRRMO (DISASTER RISK REDUCTION)</option>
            <option value="TURISMO">TOURISM</option>
            <option value="OTHER">SPECIFY / OTHER</option>
          </select>
          <input type="text" id="otherOfficeName" placeholder="Ipasok ang pangalan ng Tanggapan..." style="display:none;" oninput="updateOfficeTitle(this.value)">
        </div>
        <!-- End Office Selector -->

      </div>
    </header>

    <div class="divider"></div>
    <h4>TULUNGAN MO KAMI MAS MAPABUTI ANG AMING MGA PROSESO AT SERBISYO!</h4>

    <p class="instructions">
      Ang Client Satisfaction Measurement (CSM) ay naglalayong masubaybayan ang karanasan ng taumbayan hinggil sa kanilang pakikitransaksyon sa mga tanggapan ng gobyerno. 
      Makatutulong ang inyong kasagutan upang mas mapabuti at lalong mapahusay ang aming serbisyo publiko. 
      Ang inyong ibinahaging impormasyon ay mananatiling kumpidensyal. Maaari ring piliin na hindi sagutan ang sarbey na ito.
    </p>

    <div class="form-section">
      <div class="form-group inline-group">
        <label>Uri ng Kliyente:</label>
        <label><input type="checkbox"> Mamamayan</label>
        <label><input type="checkbox"> Negosyo</label>
        <label><input type="checkbox"> Gobyerno</label>
      </div>

      <div class="form-group inline-group">
        <label>Petsa:</label> <input type="date">
        <label>Kasarian:</label>
        <label><input type="checkbox"> Lalaki</label>
        <label><input type="checkbox"> Babae</label>
        <label>Edad:</label> <input type="number" min="1" style="width:80px">
      </div>

      <div class="form-group">
        <label for="rehiyonSelect">Rehiyon:</label> 
        <select id="rehiyonSelect" name="rehiyon" style="margin-top: 5px; min-height: 40px; padding: 10px 12px;">
            <option value="" disabled selected>Pumili ng Rehiyon</option>
            <option value="NCR">National Capital Region (NCR) - Metro Manila</option>
            <option value="CAR">Cordillera Administrative Region (CAR) - Northern Luzon highlands</option>
            <option value="Region I">Region I (Ilocos Region) - Northwest Luzon</option>
            <option value="Region II">Region II (Cagayan Valley) - Northeast Luzon</option>
            <option value="Region III">Region III (Central Luzon) - Central Luzon</option>
            <option value="Region IV-A">Region IV-A (CALABARZON) - Southern Tagalog</option>
            <option value="Region IV-B">Region IV-B (Mimaropa) - Mindoro, Marinduque, Romblon, Palawan</option>
            <option value="Region V">Region V (Bicol Region) - Southeast Luzon</option>
            <option value="Region VI">Region VI (Western Visayas) - Central Philippines</option>
            <option value="Region VII">Region VII (Central Visayas) - Central Philippines</option>
            <option value="Region VIII">Region VIII (Eastern Visayas) - Eastern Philippines</option>
            <option value="Region IX">Region IX (Zamboanga Peninsula) - Western Mindanao</option>
            <option value="Region X">Region X (Northern Mindanao) - Northern Mindanao</option>
            <option value="Region XI">Region XI (Davao Region) - Southern Mindanao</option>
            <option value="Region XII">Region XII (Soccsksargen) - South-Central Mindanao</option>
            <option value="Region XIII">Region XIII (Caraga) - Northeastern Mindanao</option>
            <option value="BARMM">Bangsamoro Autonomous Region in Muslim Mindanao (BARMM)</option>
        </select>
      </div>

      <div class="form-group">
        <label>Uri ng transaksyon o serbisyo:</label><input type="text" style="margin-top: 5px; min-height: 40px; padding: 10px 12px;">
      </div>
    </div>

    <h4 class="section-title">Citizen's Charter (CC)</h4>
    <p class="instructions">Lagyan ng tsek (‚úì) ang angkop na sagot.</p>

    <div class="form-section">
      <label>CC1. Alin sa mga sumusunod ang naglalarawan sa iyong kaalaman sa CC?</label>
      <div class="checkbox-group">
        <label><input type="checkbox"> 1. Alam ko ang CC at nakita ko ito sa napuntahang opisina</label>
        <label><input type="checkbox"> 2. Alam ko ang CC pero hindi ko ito nakita sa napuntahang opisina</label>
        <label><input type="checkbox"> 3. Nalaman ko ang CC nang makita ko ito sa napuntahang opisina</label>
        <label><input type="checkbox"> 4. Hindi ko alam kung ano ang CC at wala akong nakita sa opisina</label>
      </div>

      <label>CC2. Kung alam ang CC, masasabi mo ba na ang CC ng opisina ay...</label>
      <div class="checkbox-group">
        <label><input type="checkbox"> 1. Madaling makita</label>
        <label><input type="checkbox"> 2. Medyo madaling makita</label>
        <label><input type="checkbox"> 3. Mahirap makita</label>
        <label><input type="checkbox"> 4. Hindi makita</label>
        <label><input type="checkbox"> 5. N/A</label>
      </div>

      <label>CC3. Kung alam ang CC, gaano nakatulong ang CC sa transaksyon mo?</label>
      <div class="checkbox-group">
        <label><input type="checkbox"> 1. Sobrang nakatulong</label>
        <label><input type="checkbox"> 2. Nakatulong naman</label>
        <label><input type="checkbox"> 3. Hindi nakatulong</label>
        <label><input type="checkbox"> 4. N/ A</label>
      </div>
    </div>
  </div>

  <!-- PAGE 2 -->
  <div class="container page-break" id="page2">
    <h4 class="section-title">Satisfaction Questions (SQD 0-8)</h4>
    <p class="instructions">Pumili ng isang emoji na pinakaangkop sa iyong sagot.</p>

    <table id="emojiTable">
      <thead>
        <tr>
          <th class="question">Mga Pahayag</th>
          <th><span class="emoji red">üò†</span>Lubos na<br>hindi sumasang-ayon</th>
          <th><span class="emoji orange">üôÅ</span>Hindi<br>sumasang-ayon</th>
          <th><span class="emoji gray">üòê</span>Walang<br>kinikilingan</th>
          <th><span class="emoji lightgreen">üôÇ</span>Sumasang-ayon</th>
          <th><span class="emoji green">üòÉ</span>Labis na<br>sumasang-ayon</th>
          <th><span class="emoji na">üö´</span>N/A</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="form-section">
      <label>Mga suhestiyon (opsyonal):</label>
      <textarea></textarea>
      <label>Email address (opsyonal):</label>
      <input type="text">
    </div>

    <button class="submit-btn" id="submitButton" onclick="savePDF()" disabled>Loading PDF Tools...</button>

    <div class="footer">MARAMING SALAMAT!</div>
  </div>

  <!-- VIRTUAL KEYBOARD -->
  <div id="virtual-keyboard">
    <div class="keyboard-row">
      <button type="button" class="keyboard-key" data-key="1">1</button>
      <button type="button" class="keyboard-key" data-key="2">2</button>
      <button type="button" class="keyboard-key" data-key="3">3</button>
      <button type="button" class="keyboard-key" data-key="4">4</button>
      <button type="button" class="keyboard-key" data-key="5">5</button>
      <button type="button" class="keyboard-key" data-key="6">6</button>
      <button type="button" class="keyboard-key" data-key="7">7</button>
      <button type="button" class="keyboard-key" data-key="8">8</button>
      <button type="button" class="keyboard-key" data-key="9">9</button>
      <button type="button" class="keyboard-key" data-key="0">0</button>
      <button type="button" class="keyboard-key key-special key-backspace" data-key="BACKSPACE">‚å´</button>
    </div>
    <div class="keyboard-row">
      <button type="button" class="keyboard-key" data-key="q">q</button>
      <button type="button" class="keyboard-key" data-key="w">w</button>
      <button type="button" class="keyboard-key" data-key="e">e</button>
      <button type="button" class="keyboard-key" data-key="r">r</button>
      <button type="button" class="keyboard-key" data-key="t">t</button>
      <button type="button" class="keyboard-key" data-key="y">y</button>
      <button type="button" class="keyboard-key" data-key="u">u</button>
      <button type="button" class="keyboard-key" data-key="i">i</button>
      <button type="button" class="keyboard-key" data-key="o">o</button>
      <button type="button" class="keyboard-key" data-key="p">p</button>
    </div>
    <div class="keyboard-row">
      <button type="button" class="keyboard-key" data-key="a">a</button>
      <button type="button" class="keyboard-key" data-key="s">s</button>
      <button type="button" class="keyboard-key" data-key="d">d</button>
      <button type="button" class="keyboard-key" data-key="f">f</button>
      <button type="button" class="keyboard-key" data-key="g">g</button>
      <button type="button" class="keyboard-key" data-key="h">h</button>
      <button type="button" class="keyboard-key" data-key="j">j</button>
      <button type="button" class="keyboard-key" data-key="k">k</button>
      <button type="button" class="keyboard-key" data-key="l">l</button>
      <button type="button" class="keyboard-key" data-key="@">@</button>
    </div>
    <div class="keyboard-row">
      <button type="button" class="keyboard-key key-special" data-key="SHIFT">‚áß</button>
      <button type="button" class="keyboard-key" data-key="z">z</button>
      <button type="button" class="keyboard-key" data-key="x">x</button>
      <button type="button" class="keyboard-key" data-key="c">c</button>
      <button type="button" class="keyboard-key" data-key="v">v</button>
      <button type="button" class="keyboard-key" data-key="b">b</button>
      <button type="button" class="keyboard-key" data-key="n">n</button>
      <button type="button" class="keyboard-key" data-key="√±">√±</button>
      <button type="button" class="keyboard-key" data-key="m">m</button>
      <button type="button" class="keyboard-key" data-key=".">.</button>
      <button type="button" class="keyboard-key" data-key="-">-</button>
    </div>
    <div class="keyboard-row">
      <button type="button" class="keyboard-key key-space" data-key="SPACE">Space</button>
      <button type="button" class="keyboard-key key-special key-close" data-key="CLOSE">Close</button>
    </div>
  </div>
  <!-- END VIRTUAL KEYBOARD -->

  <script>
    // Update office title
    function updateOfficeTitle(value) {
        const officeTitleElement = document.getElementById('officeTitle');
        const otherOfficeInput = document.getElementById('otherOfficeName');
        const prefix = "PAMBAYANG TANGGAPAN NG ";

        if (value === 'OTHER') {
            otherOfficeInput.style.display = 'block';
            otherOfficeInput.focus();
            officeTitleElement.textContent = prefix + 'IBANG TANGGAPAN';
        } else if (value === 'TAGATALA' && otherOfficeInput.style.display === 'block') {
            otherOfficeInput.style.display = 'none';
            officeTitleElement.textContent = prefix + 'TAGATALA';
            otherOfficeInput.value = '';
        } else if (value === 'TAGATALA' && otherOfficeInput.style.display === 'none') {
            officeTitleElement.textContent = prefix + 'TAGATALA';
        } else {
            otherOfficeInput.style.display = 'none';
            officeTitleElement.textContent = prefix + value;
        }
    }

    // Get office name for filename
    function getCurrentOfficeName() {
        const officeSelect = document.getElementById('officeSelect');
        const otherOfficeInput = document.getElementById('otherOfficeName');

        if (officeSelect.value === 'OTHER' && otherOfficeInput.value.trim()) {
            return otherOfficeInput.value.trim().replace(/[^a-zA-Z0-9_-]/g, '_');
        }

        return officeSelect.value;
    }

    // Initialize PDF generator (enable button when libs loaded)
    function initializePdfGenerator() {
        const submitButton = document.getElementById('submitButton');
        let retryCount = 0;
        const maxRetries = 40; // 10 seconds max wait (40 * 250ms)

        function checkLibraries() {
            if (typeof window.html2canvas === 'undefined' || typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
                retryCount++;
                if (retryCount < maxRetries) {
                    setTimeout(checkLibraries, 250);
                } else {
                    submitButton.textContent = "Error: PDF libraries failed to load";
                    submitButton.style.backgroundColor = "#dc3545";
                }
            } else {
                submitButton.disabled = false;
                submitButton.textContent = "Isumite";
            }
        }

        checkLibraries();
    }

    document.addEventListener("DOMContentLoaded", () => {
      const questions = [
        "Nasiyahan ako sa serbisyo na aking natanggap sa napuntahang tanggapan.",
        "Makatwiran ang oras na aking ginugol para sa pagproseso ng aking transaksyon.",
        "Ang opisina ay sumusunod sa mga kinakailangang dokumento at mga hakbang batay sa impormasyong ibinigay.",
        "Ang mga hakbang sa pagproseso, kasama na ang pagbayad ay madali at simple lamang.",
        "Mabilis at madali akong nakahanap ng impormasyon tungkol sa aking transaksyon mula sa opisina o sa website nito.",
        "Nagbayad ako ng makatwirang halaga para sa aking transaksyon. (Kung libre, lagyan ng tsek ang N/A.)",
        "Pakiramdam ko ay patas ang opisina sa lahat, o 'walang palakasan', sa aking transaksyon.",
        "Magalang akong trinato ng mga tauhan, at (kung humingi ako ng tulong) alam ko na sila ay handang tumulong sa akin.",
        "Nakuha ko ang kinakailangan ko mula sa tanggapan ng gobyerno; kung tinanggihan man, ito ay sapat na ipinaliwanag sa akin."
      ];

      const tbody = document.querySelector("#emojiTable tbody");
      questions.forEach((q, i) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td class="question">SQD${i}. ${q}</td>
          ${Array.from({ length: 6 }, (_, j) => `<td><input type="radio" name="sqd${i}" value="${j+1}"></td>`).join("")}
        `;
        tbody.appendChild(row);
      });

      // Virtual keyboard logic
      let activeInputElement = null;
      let isShiftActive = false;
      const keyboard = document.getElementById("virtual-keyboard");

      const inputSelector = 'input[type="text"]:not(#otherOfficeName), input[type="number"], textarea, #otherOfficeName';

      if (keyboard) {
        const allKeys = keyboard.querySelectorAll(".keyboard-key");

        document.querySelectorAll(inputSelector).forEach(input => {
          if (input.id === 'otherOfficeName' && input.style.display === 'none') {
            // do nothing until shown
          } else {
            input.addEventListener('focus', () => {
              activeInputElement = input;
              keyboard.style.display = 'block';
            });
          }
        });

        const otherOfficeInput = document.getElementById('otherOfficeName');
        otherOfficeInput.addEventListener('focus', () => {
            activeInputElement = otherOfficeInput;
            keyboard.style.display = 'block';
        });

        keyboard.addEventListener('click', (e) => {
          if (!e.target.matches('.keyboard-key')) return;
          if (!activeInputElement) return;

          activeInputElement.focus();
          const key = e.target.dataset.key;

          switch (key) {
            case 'BACKSPACE':
              activeInputElement.value = activeInputElement.value.slice(0, -1);
              if (activeInputElement.id === 'otherOfficeName') {
                  updateOfficeTitle(activeInputElement.value);
              }
              break;
            case 'SPACE':
              activeInputElement.value += ' ';
              if (activeInputElement.id === 'otherOfficeName') {
                  updateOfficeTitle(activeInputElement.value);
              }
              break;
            case 'CLOSE':
              keyboard.style.display = 'none';
              activeInputElement.blur();
              activeInputElement = null;
              break;
            case 'SHIFT':
              isShiftActive = !isShiftActive;
              toggleShiftCase(allKeys);
              break;
            default:
              const value = isShiftActive ? key.toUpperCase() : key.toLowerCase();
              activeInputElement.value += value;
              if (activeInputElement.id === 'otherOfficeName') {
                  updateOfficeTitle(activeInputElement.value);
              }
          }
        });

        function toggleShiftCase(keys) {
          const shiftButton = keyboard.querySelector('[data-key="SHIFT"]');
          shiftButton.classList.toggle('key-shift-active', isShiftActive);

          keys.forEach(key => {
            const keyValue = key.dataset.key;
            if (keyValue && (keyValue.length === 1 && keyValue.match(/[a-z]/i) || keyValue === '√±')) {
              key.textContent = isShiftActive ? keyValue.toUpperCase() : keyValue.toLowerCase();
            }
          });
        }

        document.addEventListener('click', (e) => {
            if (keyboard.style.display !== 'block' || keyboard.contains(e.target)) return;
            const clickedOnInput = e.target.matches(inputSelector);
            const clickedOnRegionSelect = e.target.id === 'rehiyonSelect';

            if (!clickedOnInput && !clickedOnRegionSelect) {
                keyboard.style.display = 'none';
                if (activeInputElement) activeInputElement.blur();
                activeInputElement = null;
            }
        });
      }

      // Start the PDF library checker when the DOM is ready
      initializePdfGenerator();
    });

    async function savePDF() {
      const PDF_RENDER_SCALE = 2.5;

      // obtain jsPDF from window (imported from CDN)
      const { jsPDF } = window.jspdf;
      const overlay = document.getElementById("overlay");
      const overlayMessage = overlay.querySelector('p');
      const button = document.getElementById("submitButton");

      // create a new jsPDF instance per invocation
      const pdf = new jsPDF("p", "mm", "a4");
      const pageWidth = pdf.internal.pageSize.getWidth();

      const officeName = getCurrentOfficeName();
      const now = new Date();
      const timestamp = now.toISOString().replace(/[:.]/g, '-').slice(0, -5); // More unique timestamp
      const filename = `CSM_${officeName}_${timestamp}.pdf`;

      overlayMessage.textContent = "Nagsasagawa ng PDF... Paki-hintay.";
      overlay.style.display = "flex";
      button.disabled = true; // prevent double clicks

      try {
        // Hide elements for PDF generation
        document.querySelectorAll(".emoji").forEach(e => e.classList.add("grayscale"));
        button.style.display = "none";
        
        // short delay to ensure styles applied
        await new Promise(r => setTimeout(r, 100));

        const page1 = document.getElementById("page1");
        const page2 = document.getElementById("page2");

        // Capture Page 1
        const canvas1 = await html2canvas(page1, { scale: PDF_RENDER_SCALE, useCORS: true });
        const img1 = canvas1.toDataURL("image/png");
        const imgWidth1 = pageWidth;
        const imgHeight1 = (canvas1.height * imgWidth1) / canvas1.width;

        // Capture Page 2
        const canvas2 = await html2canvas(page2, { scale: PDF_RENDER_SCALE, useCORS: true });
        const img2 = canvas2.toDataURL("image/png");
        const imgWidth2 = pageWidth;
        const imgHeight2 = (canvas2.height * imgWidth2) / canvas2.width;

        // Add Page 1
        pdf.addImage(img1, "PNG", 0, 0, imgWidth1, imgHeight1);

        // Add Page 2
        pdf.addPage();
        pdf.addImage(img2, "PNG", 0, 0, imgWidth2, imgHeight2);

        // Generate blob and use object URL for download
        const blob = pdf.output("blob");
        const blobUrl = URL.createObjectURL(blob);

        // Create a completely fresh anchor element for each download
        const link = document.createElement("a");
        link.style.display = "none";
        link.href = blobUrl;
        link.download = filename;
        link.target = "_blank"; // Help with some kiosk browsers
        
        document.body.appendChild(link);
        
        // Force click with delay to ensure DOM updates
        setTimeout(() => {
          link.click();
          
          // Clean up after a short delay
          setTimeout(() => {
            document.body.removeChild(link);
            URL.revokeObjectURL(blobUrl);
          }, 500);
        }, 100);

        overlayMessage.textContent = "Maraming salamat po!";
      } catch (error) {
        console.error("PDF Generation Failed:", error);
        overlayMessage.textContent = "Pumalya ang paggawa ng PDF. Pakisubukang muli. (Tingnan ang console para sa detalye)";
      } finally {
        // restore UI state and remove grayscale
        document.querySelectorAll(".emoji").forEach(e => e.classList.remove("grayscale"));
        button.style.display = "block";

        setTimeout(() => {
          overlay.style.display = "none";
          button.disabled = false;
          button.textContent = "Isumite";
          overlayMessage.textContent = "Loading..."; // reset
        }, 2000);
      }
    }
  </script>
</body>
</html>